{% extends "base.html" %}

{% block title %}Deal Flow Tracker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='layout.css') }}">
<style>
    .deal-flow-container {
        background: white;
        border-radius: 8px;
        padding: 0.4rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid #e8e8e8;
    }
    
    .deal-flow-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.4rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid #e8e8e8;
    }
    
    .deal-flow-header h2 {
        font-size: 0.75rem;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0;
    }
    
    /* Responsive table wrapper for horizontal scroll on small screens */
    .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 6px;
    }
    
    .filter-buttons {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 0.2rem 0.4rem;
        border: 1px solid #e5e5e5;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.6rem;
        font-weight: 500;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .filter-btn:hover {
        border-color: #4c1d95;
        background: #f8f9ff;
        color: #4c1d95;
    }
    
    .filter-btn.active {
        background: #4c1d95;
        color: white;
        border-color: #4c1d95;
    }
    
    .deals-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.6rem;
        min-width: 900px; /* force horizontal scroll on narrow screens */
    }
    
    .deals-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #e8e8e8;
    }
    
    .deals-table th {
        padding: 0.4rem 0.3rem;
        text-align: left;
        font-weight: 700;
        color: #1a1a1a;
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }
    
    .deals-table td {
        padding: 0.4rem 0.3rem;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
        white-space: nowrap;
    }
    
    .deals-table tbody tr {
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .deals-table tbody tr:hover {
        background: #f8f9ff;
    }
    
    .deals-table tbody tr:active {
        background: #f0f0ff;
    }
    
    .deal-company {
        font-weight: 600;
        color: #1a1a1a;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .deal-pe-firm {
        color: #4c1d95;
        font-weight: 500;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .deal-type-badge {
        display: inline-block;
        padding: 0.1rem 0.3rem;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 4px;
        font-size: 0.55rem;
        font-weight: 500;
    }
    
    .deal-status-badge {
        display: inline-block;
        padding: 0.1rem 0.3rem;
        border-radius: 4px;
        font-size: 0.55rem;
        font-weight: 600;
    }
    
    .deal-status-badge.completed {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .deal-status-badge.announced {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .deal-status-badge.pending {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .deal-date {
        color: #666;
        white-space: nowrap;
    }
    
    .deal-size {
        color: #4c1d95;
        font-weight: 600;
    }

    @media (max-width: 640px) {
        .deal-flow-container { padding: 0.3rem; }
        .filter-btn { font-size: 0.55rem; }
        .deals-table { font-size: 0.55rem; min-width: 800px; }
        .deal-company, .deal-pe-firm { max-width: 140px; }
    }
    
    /* Modal Styles */
    .deal-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
    }
    
    .deal-modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .deal-modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .deal-modal-header h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 700;
    }
    
    .deal-modal-close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
        border: none;
        background: none;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .deal-modal-close:hover {
        opacity: 1;
    }
    
    .deal-modal-body {
        padding: 1.5rem;
    }
    
    .deal-detail-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .deal-detail-row:last-child {
        border-bottom: none;
    }
    
    .deal-detail-label {
        font-weight: 700;
        color: #666;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .deal-detail-value {
        color: #1a1a1a;
        font-size: 0.75rem;
        line-height: 1.5;
    }
    
    .deal-detail-value.description {
        white-space: pre-wrap;
        line-height: 1.6;
    }
    
    .deal-detail-value a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
    }
    
    .deal-detail-value a:hover {
        text-decoration: underline;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: #999;
    }
    
    .no-deals {
        text-align: center;
        padding: 2rem;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="deal-flow-container">
    <div class="deal-flow-header">
        <h2><i class="fas fa-exchange-alt"></i> Deal Flow Tracker</h2>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="Investment">Investment</button>
            <button class="filter-btn" data-filter="Acquisition">Acquisition</button>
            <button class="filter-btn" data-filter="Divestment">Divestment</button>
            <button class="filter-btn" data-filter="Completed">Completed</button>
            <button class="filter-btn" data-filter="Announced">Announced</button>
        </div>
    </div>
    
    <div id="dealsContainer">
        <div class="loading">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p>Loading deals...</p>
        </div>
    </div>
</div>

<!-- Deal Detail Modal -->
<div id="dealModal" class="deal-modal">
    <div class="deal-modal-content">
        <div class="deal-modal-header">
            <h2 id="modalTitle">Deal Details</h2>
            <button class="deal-modal-close" onclick="closeDealModal()">&times;</button>
        </div>
        <div class="deal-modal-body" id="modalBody">
            <!-- Details will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
let allDeals = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadDeals();
    setupFilters();
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('dealModal');
    if (event.target === modal) {
        closeDealModal();
    }
};

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDealModal();
    }
});

async function loadDeals() {
    try {
        const response = await fetch('/api/deal-flow');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Sort deals by date - newest first
            allDeals = data.deals.sort((a, b) => {
                const dateA = a.date || '1900-01-01';
                const dateB = b.date || '1900-01-01';
                return new Date(dateB) - new Date(dateA);
            });
            displayDeals(allDeals);
        } else {
            document.getElementById('dealsContainer').innerHTML = `
                <div class="no-deals">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Error loading deals: ${data.message || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading deals:', error);
        document.getElementById('dealsContainer').innerHTML = `
            <div class="no-deals">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px; opacity: 0.3;"></i>
                <p>Error loading deals: ${error.message}</p>
            </div>
        `;
    }
}

function setupFilters() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            applyFilter();
        });
    });
}

function applyFilter() {
    let filtered = allDeals;
    
    if (currentFilter !== 'all') {
        if (currentFilter === 'Completed' || currentFilter === 'Announced') {
            filtered = allDeals.filter(d => d.status === currentFilter);
        } else {
            filtered = allDeals.filter(d => d.deal_type === currentFilter);
        }
    }
    
    displayDeals(filtered);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function displayDeals(deals) {
    const container = document.getElementById('dealsContainer');
    
    if (deals.length === 0) {
        container.innerHTML = `
            <div class="no-deals">
                <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.3;"></i>
                <p>No deals match your filter</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-wrapper">
        <table class="deals-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Company</th>
                    <th>PE Firm</th>
                    <th>Deal Type</th>
                    <th>Sector</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Geography</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    deals.forEach(deal => {
        const date = deal.date ? new Date(deal.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
        const statusClass = deal.status ? deal.status.toLowerCase().replace(/\s+/g, '-') : 'unknown';
        
        html += `
            <tr onclick="showDealModal('${deal.id || ''}')" data-deal-id="${deal.id || ''}">
                <td class="deal-date">${escapeHtml(date)}</td>
                <td class="deal-company">${escapeHtml(deal.company || 'N/A')}</td>
                <td class="deal-pe-firm">${escapeHtml(deal.pe_firm || 'N/A')}</td>
                <td><span class="deal-type-badge">${escapeHtml(deal.deal_type || 'N/A')}</span></td>
                <td>${escapeHtml(deal.sector || 'N/A')}</td>
                <td class="deal-size">${escapeHtml(deal.deal_size || 'N/A')}</td>
                <td><span class="deal-status-badge ${statusClass}">${escapeHtml(deal.status || 'N/A')}</span></td>
                <td>${escapeHtml(deal.geography || 'N/A')}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function showDealModal(dealId) {
    const deal = allDeals.find(d => d.id === dealId);
    if (!deal) {
        console.error('Deal not found:', dealId);
        return;
    }
    
    const modal = document.getElementById('dealModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    
    modalTitle.textContent = `${deal.company || 'Deal'} - ${deal.deal_type || 'Transaction'}`;
    
    let html = '';
    
    // Create detail rows for all available fields (excluding source-related fields)
    const fields = [
        { label: 'Company', value: deal.company },
        { label: 'PE Firm', value: deal.pe_firm },
        { label: 'Deal Type', value: deal.deal_type },
        { label: 'Status', value: deal.status },
        { label: 'Sector', value: deal.sector },
        { label: 'Deal Size', value: deal.deal_size },
        { label: 'Date', value: deal.date ? new Date(deal.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : null },
        { label: 'Geography', value: deal.geography },
        { label: 'URL', value: deal.url, isLink: true },
        { label: 'Title', value: deal.title },
        { label: 'Description', value: deal.description, isDescription: true }
    ];
    
    // Fields to exclude (source-related field names)
    const excludeFieldNames = ['source'];
    
    // Check if a value looks like a source identifier (e.g., "excel_deal_123", "excel import")
    function isSourceIdentifier(value) {
        if (!value) return false;
        const str = String(value).toLowerCase();
        return str.includes('excel_') || str.includes('excel import') || str.includes('import_') || 
               (str.startsWith('excel') && str.includes('deal'));
    }
    
    fields.forEach(field => {
        if (field.value && !isSourceIdentifier(field.value)) {
            html += `
                <div class="deal-detail-row">
                    <div class="deal-detail-label">${escapeHtml(field.label)}</div>
                    <div class="deal-detail-value ${field.isDescription ? 'description' : ''}">
                        ${field.isLink ? `<a href="${escapeHtml(field.value)}" target="_blank" rel="noopener noreferrer">${escapeHtml(field.value)}</a>` : escapeHtml(field.value)}
                    </div>
                </div>
            `;
        }
    });
    
    // Show any additional fields that might exist (excluding source-related)
    Object.keys(deal).forEach(key => {
        const lowerKey = key.toLowerCase();
        const isExcludedName = excludeFieldNames.some(exclude => lowerKey === exclude);
        const fieldExists = fields.some(f => f.label.toLowerCase() === key.toLowerCase());
        
        if (!fieldExists && !isExcludedName && deal[key] && typeof deal[key] !== 'object') {
            // Only exclude if it's an ID field with source identifier pattern
            if (lowerKey === 'id' && isSourceIdentifier(deal[key])) {
                return; // Skip this field
            }
            
            if (!isSourceIdentifier(deal[key])) {
                html += `
                    <div class="deal-detail-row">
                        <div class="deal-detail-label">${escapeHtml(key.charAt(0).toUpperCase() + key.slice(1))}</div>
                        <div class="deal-detail-value">${escapeHtml(String(deal[key]))}</div>
                    </div>
                `;
            }
        }
    });
    
    modalBody.innerHTML = html;
    modal.style.display = 'block';
}

function closeDealModal() {
    document.getElementById('dealModal').style.display = 'none';
}
</script>
{% endblock %}
